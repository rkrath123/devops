Provisioners
=============

![image](https://user-images.githubusercontent.com/53966749/208067061-b260fff9-dbfb-422d-8af8-b699decbf371.png)

![image](https://user-images.githubusercontent.com/53966749/208067303-c8473c78-455d-48b7-be2e-e5deac4348be.png)

```
main.tf
---------
provider "aws" {
  region     = "us-west-2"
  access_key = ""
  secret_key = "/17B45NJz"
 
}



resource "aws_instance" "myec2" {
   ami = "ami-0ca285d4c2cda3300"
   instance_type = "t2.micro"
   key_name = "ramakant"

   connection {
   type     = "ssh"
   user     = "ec2-user"
   private_key = file("ramakant.pem")
   host     = self.public_ip
    }



 provisioner "remote-exec" {
   inline = [
     "sudo amazon-linux-extras install -y nginx1",
     "sudo systemctl start nginx"
   ]
 }
}

terraform  apply
---------------

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # aws_instance.myec2 will be created
  + resource "aws_instance" "myec2" {
      + ami                                  = "ami-0ca285d4c2cda3300"
   
aws_instance.myec2 (remote-exec): Connected!
aws_instance.myec2 (remote-exec): Installing nginx
aws_instance.myec2 (remote-exec): Loaded plugins: extras_suggestions,
aws_instance.myec2 (remote-exec):               : langpacks, priorities,
aws_instance.myec2 (remote-exec):               : update-motd
aws_instance.myec2 (remote-exec): Existing lock /var/run/yum.pid: another copy is running as pid 3265.

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
```

```
terraform init
terraform plan
terraform apply -auto-approve
terraform destroy -auto-approve

```

![image](https://user-images.githubusercontent.com/53966749/208091842-907f2b4e-601b-42ef-bd75-608d86f8a682.png)
![image](https://user-images.githubusercontent.com/53966749/208091901-9a85c37c-8aba-411e-8a49-62a6c984ba0f.png)


Types of Provisioners
---------------------

![image](https://user-images.githubusercontent.com/53966749/208093056-9d8bc1e8-75d7-4365-9896-ed822a135fe6.png)

![image](https://user-images.githubusercontent.com/53966749/208092455-30dac7c2-c5da-471d-a328-89cb67408d01.png)

![image](https://user-images.githubusercontent.com/53966749/208092513-30bb8e94-544d-4911-911f-cc0819678148.png)

![image](https://user-images.githubusercontent.com/53966749/208092943-a228c18e-0c89-4b46-bf45-603e7ad50e3a.png)



local-exec provisioners
-----------------------

```
resource "aws_instance" "myec2" {
  ami           = "ami-0ca285d4c2cda3300"
  instance_type = "t2.micro"
  key_name      = "ramakant"
  

  provisioner "local-exec" {
    command = "echo ${aws_instance.myec2.public_ip} >> public_ips.txt"

  }

}

terraform apply
---------------
Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes

aws_instance.myec2: Creating...
aws_instance.myec2: Still creating... [10s elapsed]
aws_instance.myec2: Still creating... [20s elapsed]
aws_instance.myec2: Still creating... [30s elapsed]
aws_instance.myec2: Provisioning with 'local-exec'...
aws_instance.myec2 (local-exec): Executing: ["cmd" "/C" "echo 54.218.67.122 >> public_ips.txt"]
aws_instance.myec2: Creation complete after 37s [id=i-0f9cd85cdb89a116a]


public_ips.txt
--------------
54.218.67.122 


```


```
Important Note:
Make sure to have the ec2-key.pem file present in the working directory for the provisioner to be able to connect to the instance.

Demo Code Used During Demo:
provider "aws" {
  region     = "ap-southeast-1"
  access_key = "YOUR-KEY"
  secret_key = "YOUR-KEY"
}


resource "aws_security_group" "allow_ssh" {
  name        = "allow_ssh"
  description = "Allow SSH inbound traffic"

  ingress {
    description = "SSH into VPC"
    from_port   = 22
    to_port     = 22
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
  egress {
    description = "Outbound Allowed"
    from_port   = 0
    to_port     = 65535
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
}


resource "aws_instance" "myec2" {
   ami = "ami-0b1e534a4ff9019e0"
   instance_type = "t2.micro"
   key_name = "ec2-key"
   vpc_security_group_ids  = [aws_security_group.allow_ssh.id]

   provisioner "remote-exec" {
     inline = [
       "sudo yum -y install nano"
     ]
   }
   provisioner "remote-exec" {
       when    = destroy
       inline = [
         "sudo yum -y remove nano"
       ]
     }
   connection {
     type = "ssh"
     user = "ec2-user"
     private_key = file("./ec2-key.pem")
     host = self.public_ip
   }
}

get list of of running EC2 ip
----------------------------

```

ec2.tf
------
data "aws_instances" "test" {

instance_state_names = ["running"]
}

output "instances" {
value = "${data.aws_instances.test.public_ips}"
}


terraform apply
---------------
Apply complete! Resources: 0 added, 0 changed, 0 destroyed.

Outputs:

instances = tolist([
  "34.209.245.176",
])
```

