Services
==========

![image](https://user-images.githubusercontent.com/53966749/200308850-fdfca5f7-6660-4633-a1bb-dacdfb0674f3.png)
![image](https://user-images.githubusercontent.com/53966749/200308897-87a9d5ad-d37f-4424-9f8b-8d123aed4736.png)


cluster ip
===========
![image](https://user-images.githubusercontent.com/53966749/200310656-64f15e61-0e78-4a60-8333-d08907ece15f.png)

```
sles15sp3:~/test # kubectl create deployment --image=nginx my-nginx --replicas=3 --port=80
deployment.apps/my-nginx created

sles15sp3:~/test # kubectl get pods --show-labels
NAME                       READY   STATUS    RESTARTS   AGE     LABELS
my-nginx-ddc8f96f8-hrzns   1/1     Running   0          6m38s   app=my-nginx,pod-template-hash=ddc8f96f8
my-nginx-ddc8f96f8-j8hcj   1/1     Running   0          6m38s   app=my-nginx,pod-template-hash=ddc8f96f8
my-nginx-ddc8f96f8-sqw9m   1/1     Running   0          6m38s   app=my-nginx,pod-template-hash=ddc8f96f8

sles15sp3:~/test # cat service-selector.yaml
apiVersion: v1
kind: Service
metadata:
   name: kplabs-service-selector
spec:
   selector:
     app: my-nginx
   ports:
   - port: 80
     targetPort: 80
sles15sp3:~/test # kubectl apply -f service-selector.yaml
service/kplabs-service-selector created

sles15sp3:~/test # kubectl get service
NAME                      TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kplabs-service-selector   ClusterIP   10.12.5.70   <none>        80/TCP    36s
kubernetes                ClusterIP   10.12.0.1    <none>        443/TCP   25d
sles15sp3:~/test # kubectl describe service kplabs-service-selector
Name:              kplabs-service-selector
Namespace:         default
Labels:            <none>
Annotations:       cloud.google.com/neg: {"ingress":true}
Selector:          app=my-nginx
Type:              ClusterIP
IP Family Policy:  SingleStack
IP Families:       IPv4
IP:                10.12.5.70
IPs:               10.12.5.70
Port:              <unset>  80/TCP
TargetPort:        80/TCP
Endpoints:         10.8.1.7:80,10.8.2.22:80,10.8.3.16:80
Session Affinity:  None
Events:            <none>


sles15sp3:~/test # kubectl get pods -o wide
NAME                       READY   STATUS    RESTARTS   AGE   IP          NODE                                       NOMINATED NODE   READINESS GATES
my-nginx-ddc8f96f8-hrzns   1/1     Running   0          11m   10.8.2.22   gke-cluster-1-default-pool-37115ec3-csyj   <none>           <none>
my-nginx-ddc8f96f8-j8hcj   1/1     Running   0          11m   10.8.1.7    gke-cluster-1-default-pool-37115ec3-ngw4   <none>           <none>
my-nginx-ddc8f96f8-sqw9m   1/1     Running   0          11m   10.8.3.16   gke-cluster-1-default-pool-37115ec3-beno   <none>           <none>


sles15sp3:~/test # kubectl exec -it my-nginx-ddc8f96f8-hrzns -- bash
root@my-nginx-ddc8f96f8-hrzns:/# curl 10.12.5.70
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>

root@my-nginx-ddc8f96f8-hrzns:/# curl 10.8.2.22:80
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
```

Port vs target port
====================
![image](https://user-images.githubusercontent.com/53966749/200314142-5a120c38-3791-4930-9571-059ce1f6920f.png)

```
sles15sp3:~/test # kubectl create deployment --image=nginx my-nginx --replicas=2
deployment.apps/my-nginx created
sles15sp3:~/test #
sles15sp3:~/test # kubectl expose deployment my-nginx --port=8080 --target-port=80
service/my-nginx exposed
sles15sp3:~/test #
sles15sp3:~/test # kubectl get svc
NAME         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE
kubernetes   ClusterIP   10.12.0.1     <none>        443/TCP    25d
my-nginx     ClusterIP   10.12.3.144   <none>        8080/TCP   7s
sles15sp3:~/test #
sles15sp3:~/test # kubectl get ep
NAME         ENDPOINTS                   AGE
kubernetes   34.123.239.57:443           25d
my-nginx     10.8.1.15:80,10.8.2.31:80   14s
sles15sp3:~/test #
sles15sp3:~/test # kubectl get pods -o wide
NAME                       READY   STATUS    RESTARTS   AGE   IP          NODE                                       NOMINATED NODE   READINESS GATES
my-nginx-c54945c55-4r4pn   1/1     Running   0          45s   10.8.2.31   gke-cluster-1-default-pool-37115ec3-csyj   <none>           <none>
my-nginx-c54945c55-ncr9q   1/1     Running   0          45s   10.8.1.15   gke-cluster-1-default-pool-37115ec3-ngw4   <none>           <none>
webserver                  1/1     Running   0          15m   10.8.3.25   gke-cluster-1-default-pool-37115ec3-beno   <none>           <none>
sles15sp3:~/test # kubectl run -it --rm --image=curlimages/curl curly -- sh
If you don't see a command prompt, try pressing enter.
/ $
/ $ curl 10.8.1.15:80
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>

/ $ curl 10.12.3.144:8080
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>

/ $ curl 10.8.2.31:80
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
```

 Deployments and service Manifest file 
 --------------------------------------
 ```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
        
kubectl apply -f demo-deployment.yaml

Creating Service
-----------------
apiVersion: v1
kind: Service
metadata:
   name: kplabs-service-selector
spec:
   selector:
     app: nginx
   ports:
   - port: 80
     targetPort: 80
     
 kubectl apply -f service-selector.yaml

```
NodePort
========
![image](https://user-images.githubusercontent.com/53966749/200329951-eff3bb84-ce18-4001-8d6d-1f4014823d7c.png)
```
sles15sp3:~/test # kubectl get deployments.apps --show-labels
NAME       READY   UP-TO-DATE   AVAILABLE   AGE   LABELS
my-nginx   2/2     2            2           30m   app=my-nginx

sles15sp3:~/test # cat nodeport.yaml
apiVersion: v1
kind: Service
metadata:
   name: kplabs-nodeport
spec:
   selector:
     app: my-nginx
   type: NodePort
   ports:
   - port: 80
     targetPort: 80
sles15sp3:~/test # kubectl apply -f nodeport.yaml
service/kplabs-nodeport created

sles15sp3:~/test # kubectl get svc -o wide
NAME              TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE     SELECTOR
kplabs-nodeport   NodePort    10.12.7.250   <none>        80:30897/TCP   2m11s   app=my-nginx
kubernetes        ClusterIP   10.12.0.1     <none>        443/TCP        25d     <none>

sles15sp3:~/test # kubectl get ep
NAME              ENDPOINTS                   AGE
kplabs-nodeport   10.8.1.15:80,10.8.2.31:80   32s
kubernetes        34.123.239.57:443           25d

sles15sp3:~/test # kubectl get nodes -o wide | awk '{print$1 , $7}'
NAME EXTERNAL-IP
gke-cluster-1-default-pool-37115ec3-beno 34.123.238.137
gke-cluster-1-default-pool-37115ec3-csyj 35.232.89.116
gke-cluster-1-default-pool-37115ec3-ngw4 34.28.87.42

we should able to access nginx from outside using all the node ip
sles15sp3:~/test # curl 34.123.238.137:30897
sles15sp3:~/test # curl 35.232.89.116:30897
sles15sp3:~/test # curl 34.28.87.42:30897

```

Service load balancer
=====================
![image](https://user-images.githubusercontent.com/53966749/200334740-284c12cc-5ed9-4d4c-99e5-9712ab6117c2.png)
![image](https://user-images.githubusercontent.com/53966749/200334918-0652898d-fafb-433f-a66a-9e0b77e025f5.png)

![image](https://user-images.githubusercontent.com/53966749/200336560-bc3af4a9-cc31-4f1a-bf20-2a2d9bdbe2b8.png)

```
sles15sp3:~/test # cat loadbalancer.yaml
apiVersion: v1
kind: Service
metadata:
   name: kplabs-loadbalancer
spec:
   selector:
     app: my-nginx
   type: LoadBalancer
   ports:
   - port: 80
     targetPort: 80

sles15sp3:~/test # kubectl apply -f loadbalancer.yaml
service/kplabs-loadbalancer created

sles15sp3:~/test # kubectl get svc
NAME                  TYPE           CLUSTER-IP     EXTERNAL-IP     PORT(S)        AGE
kplabs-loadbalancer   LoadBalancer   10.12.12.255   34.171.38.172   80:31562/TCP   99s
kubernetes            ClusterIP      10.12.0.1      <none>          443/TCP        25d

sles15sp3:~/test # kubectl  describe service kplabs-loadbalancer | grep -i port
Port:                     <unset>  80/TCP
TargetPort:               80/TCP
NodePort:                 <unset>  31562/TCP
sles15sp3:~/test #

its similar to nord port only extrac load balancer its creating
```
![image](https://user-images.githubusercontent.com/53966749/200337942-a3b4988c-609d-497c-8b24-63edeaea5c15.png)
![image](https://user-images.githubusercontent.com/53966749/200338149-d6856d50-528d-4c2a-ac97-aee6fe6b7911.png)

service dry run template
-------------------------
![image](https://user-images.githubusercontent.com/53966749/200338969-8a86c287-8179-4f7a-8dae-4de22b04767d.png)

Ingress
=======
![image](https://user-images.githubusercontent.com/53966749/200339455-b0d14c2d-0d44-4ee1-ba9e-d2050261b6fd.png)
![image](https://user-images.githubusercontent.com/53966749/200340071-9d6124b5-b347-44e7-abbf-6fe9bbc904f9.png)
![image](https://user-images.githubusercontent.com/53966749/200340396-36165830-efa0-42db-a1e7-dd9bcd496684.png)
![image](https://user-images.githubusercontent.com/53966749/200340879-de93af0e-8cc9-4cba-a608-efc34fa7750c.png)
![image](https://user-images.githubusercontent.com/53966749/200341044-f1c73e80-230c-42e3-9ccb-f9b35ce93461.png)
![image](https://user-images.githubusercontent.com/53966749/200341722-7c5546aa-f0b2-4fe9-b9d4-b324d7870890.png)




Helm
====
![image](https://user-images.githubusercontent.com/53966749/200342693-9050ec6f-ae9d-4cc5-ba83-abc55b3ef02b.png)

![image](https://user-images.githubusercontent.com/53966749/200342915-ddb08ede-a1f7-4e04-b051-65775c46395e.png)
![image](https://user-images.githubusercontent.com/53966749/200345821-1cb9d42d-e6bd-4dc8-b875-87f986869db0.png)

```
go to https://artifacthub.io/

sles15sp3:~/test # helm repo add my-repo https://charts.bitnami.com/bitnami
"my-repo" has been added to your repositories
sles15sp3:~/test # helm install my-release my-repo/wordpress
NAME: my-release
LAST DEPLOYED: Mon Nov  7 15:24:05 2022
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
CHART NAME: wordpress
CHART VERSION: 15.2.11
APP VERSION: 6.1.0


sles15sp3:~/test #  kubectl get pods
NAME                                    READY   STATUS    RESTARTS   AGE
my-nginx-c54945c55-4r4pn                1/1     Running   0          103m
my-nginx-c54945c55-ncr9q                1/1     Running   0          103m
my-release-mariadb-0                    0/1     Running   0          41s
my-release-wordpress-6975784f58-dv65h   0/1     Running   0          4

sles15sp3:~/test # kubectl get svc
NAME                   TYPE           CLUSTER-IP     EXTERNAL-IP     PORT(S)                      AGE
kubernetes             ClusterIP      10.12.0.1      <none>          443/TCP                      25d
my-release-mariadb     ClusterIP      10.12.14.164   <none>          3306/TCP                     116s
my-release-wordpress   LoadBalancer   10.12.8.70     34.121.190.64   80:30422/TCP,443:30497/TCP   116s

sles15sp3:~/test # helm ls
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
my-release      default         1               2022-11-07 15:24:05.369093437 +0000 UTC deployed        wordpress-15.2.11       6.1.0
sles15sp3:~/test #

sles15sp3:~/test # helm uninstall my-release
release "my-release" uninstalled

```
![image](https://user-images.githubusercontent.com/53966749/200350584-221124a5-47bc-49fb-bbe9-02450060ff8a.png)


Name based virtual hosting
==========================

```
![image](https://user-images.githubusercontent.com/53966749/200351315-56e9cea5-20f7-40a7-9c1a-13d29778514d.png)
![image](https://user-images.githubusercontent.com/53966749/200351402-ab51086b-0f1e-408e-b2fe-e21d65e105fa.png)

sles15sp3:~/test # cat ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: name-virtual-host-ingress
spec:
  ingressClassName: nginx
  rules:
  - host: website01.example.internal
    http:
      paths:
      - pathType: Prefix
        path: "/"
        backend:
          service:
            name: service1
            port:
              number: 80
  - host: website02.example.internal
    http:
      paths:
      - pathType: Prefix
        path: "/"
        backend:
          service:
            name: service2
            port:
              number: 80
sles15sp3:~/test # kubectl apply -f ingress.yaml
ingress.networking.k8s.io/name-virtual-host-ingress created
sles15sp3:~/test #
sles15sp3:~/test # kubectl get ingress
NAME                        CLASS   HOSTS                                                   ADDRESS   PORTS   AGE
name-virtual-host-ingress   nginx   website01.example.internal,website02.example.internal             80      24s
sles15sp3:~/test #
sles15sp3:~/test # kubectl describe ingress name-virtual-host-ingress
Name:             name-virtual-host-ingress
Labels:           <none>
Namespace:        default
Address:
Default backend:  default-http-backend:80 (10.8.2.6:8080)
Rules:
  Host                        Path  Backends
  ----                        ----  --------
  website01.example.internal
                              /   service1:80 (<error: endpoints "service1" not found>)
  website02.example.internal
                              /   service2:80 (<error: endpoints "service2" not found>)
Annotations:                  <none>
Events:                       <none>


```
